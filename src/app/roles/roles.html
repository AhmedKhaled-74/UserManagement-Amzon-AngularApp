<div class="container mt-4">
  <div
    class="d-flex flex-column flex-lg-row justify-content-between mb-lg-2 mb-4"
  >
    <h2 class="mb-3">Roles Management</h2>
    <div>
      <button
        class="btn btn-sm btn-info me-2"
        (click)="viewAllActivities()"
        [disabled]="isLoading"
      >
        <i class="fa-solid fa-list"></i> View All Activities
      </button>
    </div>
  </div>

  <!-- Add Role -->
  <div class="input-group mb-3">
    <input
      type="text"
      class="form-control"
      placeholder="Enter new role name"
      [(ngModel)]="newRoleName"
      [disabled]="isLoading"
    />
    <button
      class="btn btn-success"
      (click)="createRole()"
      [disabled]="!newRoleName.trim() || isLoading"
    >
      Add Role
    </button>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading roles...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="!isLoading && errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Accordion with roles -->
  <div class="accordion" id="rolesAccordion" *ngIf="!isLoading && roles.length">
    <div class="accordion-item" *ngFor="let role of roles; let i = index">
      <h2 class="accordion-header" id="heading{{ i }}">
        <button
          class="accordion-button collapsed d-flex justify-content-between"
          type="button"
          data-bs-toggle="collapse"
          [attr.data-bs-target]="'#collapse' + i"
          aria-expanded="false"
          [attr.aria-controls]="'collapse' + i"
        >
          <div class="row w-100 justify-content-between">
            <div class="col-8">
              <strong>{{ role.name }}</strong>
            </div>
          </div>
        </button>
      </h2>

      <div
        [id]="'collapse' + i"
        class="accordion-collapse collapse"
        [attr.aria-labelledby]="'heading' + i"
        data-bs-parent="#rolesAccordion"
      >
        <div class="accordion-body">
          <!-- Edit mode -->
          <div *ngIf="editingRoleId === role.id; else viewMode">
            <input
              type="text"
              class="form-control mb-2"
              [(ngModel)]="editingRoleName"
              [disabled]="isLoading"
            />
            <button
              class="btn btn-sm btn-primary me-2"
              (click)="saveEdit()"
              [disabled]="!editingRoleName.trim() || isLoading"
            >
              Save
            </button>
            <button
              class="btn btn-sm btn-secondary"
              (click)="cancelEdit()"
              [disabled]="isLoading"
            >
              Cancel
            </button>
          </div>

          <!-- View mode -->
          <ng-template #viewMode>
            <div class="d-flex justify-content-between">
              <p><strong>Role ID:</strong> {{ role.id }}</p>
              @if(role.name !== 'Admin' && role.name !=='User'){
              <div class="d-flex">
                <button
                  class="btn btn-sm btn-outline-primary me-2"
                  (click)="startEdit(role)"
                  [disabled]="isLoading"
                >
                  <i class="fa-solid fa-pen"></i> Edit
                </button>
                <button
                  class="btn btn-sm btn-outline-danger"
                  (click)="deleteRole(role.id)"
                  [disabled]="isLoading"
                >
                  <i class="fa-solid fa-trash"></i> Delete
                </button>
              </div>
              }
            </div>
            <div class="mt-3">
              <h5 class="mb-3">Role Permissions</h5>

              <div class="row g-3">
                @for (permission of getSortedPermissions(role); track
                permission) {
                <div class="col-md-6 col-lg-4">
                  <div class="card shadow-sm h-100">
                    <div
                      class="card-body d-flex justify-content-between align-items-start"
                    >
                      <div>
                        <h6 class="card-title text-primary">
                          <i class="fa-solid fa-key me-2"></i>
                          {{ permission.task }}
                        </h6>
                        <p class="card-text text-muted mb-0">
                          {{ permission.description }}
                        </p>
                      </div>

                      <button
                        class="btn btn-sm btn-outline-danger ms-2"
                        (click)="revokePermission(role.id, permission.id)"
                        [disabled]="isLoading"
                      >
                        <i class="fa-solid fa-xmark"></i>
                      </button>
                    </div>
                  </div>
                </div>
                }
              </div>
              @if(role.permissions.length === 0){
              <p class="text-danger mt-2">
                this role has no permissions assigned.
              </p>
              }

              <div class="mt-4">
                <div class="input-group">
                  <select
                    class="form-select"
                    [(ngModel)]="selectedPermissionIds[role.id]"
                  >
                    <option [ngValue]="undefined" disabled>
                      Select new permission to add
                    </option>
                    <option
                      *ngFor="let perm of getAvailablePermissions(role)"
                      [ngValue]="perm.id"
                    >
                      {{ perm.task }} - {{ perm.description }}
                    </option>
                    <option
                      *ngIf="getAvailablePermissions(role).length === 0"
                      disabled
                    ></option>
                  </select>
                  <button
                    class="btn btn-outline-success"
                    (click)="addPermissionToRole(role.id)"
                    [disabled]="!selectedPermissionIds[role.id] || isLoading"
                  >
                    <i class="fa-solid fa-plus"></i> Add
                  </button>
                </div>
              </div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div
    *ngIf="!isLoading && !roles.length && !errorMessage"
    class="alert alert-info"
  >
    No roles found.
  </div>
</div>
