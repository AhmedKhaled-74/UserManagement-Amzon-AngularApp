<div class="container mt-4">
  <h2 class="mb-3">User Management</h2>

  <!-- Role Filter -->
  <div class="mb-3">
    <select
      id="roleFilter"
      class="form-select"
      [(ngModel)]="selectedRole"
      (change)="onRoleChange()"
    >
      <option value="">All Roles</option>
      <option *ngFor="let role of roles" [value]="role.name">
        {{ role.name }}
      </option>
    </select>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading users...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="!isLoading && errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Accordion with users -->
  <div class="accordion" id="usersAccordion" *ngIf="!isLoading && users.length">
    <div class="accordion-item" *ngFor="let user of users; let i = index">
      <h2 class="accordion-header" id="heading{{ i }}">
        <button
          class="accordion-button collapsed d-flex justify-content-between"
          type="button"
          data-bs-toggle="collapse"
          [attr.data-bs-target]="'#collapse' + i"
          aria-expanded="false"
          [attr.aria-controls]="'collapse' + i"
        >
          <div class="row w-100 justify-content-between">
            <div class="col-6 col-md-8">
              <strong>{{ user.fullName }}</strong>
              <span class="text-muted ms-2 d-none d-md-inline"
                >({{ user.email }})</span
              >
            </div>
            <div class="col-6 col-md-4 text-end">
              <span [class]="getStatusClass(user.activeStatus)">
                {{ user.activeStatus }}
              </span>
              <span
                class="badge ms-2"
                [ngClass]="
                  user.role === 'Admin' ? 'bg-primary' : 'bg-secondary'
                "
              >
                {{ user.role }}
              </span>
            </div>
          </div>
        </button>
      </h2>
      <div
        [id]="'collapse' + i"
        class="accordion-collapse collapse"
        [attr.aria-labelledby]="'heading' + i"
        data-bs-parent="#usersAccordion"
      >
        <div class="accordion-body">
          <p><strong>Full Name:</strong> {{ user.fullName }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p>
            <strong>Birthdate:</strong>
            {{
              user.birthdate ? (user.birthdate | date : "mediumDate") : "N/A"
            }}
          </p>
          <p><strong>Region:</strong> {{ user.region || "N/A" }}</p>
          <p>
            <strong>Email Confirmed:</strong>
            {{ user.emailConfirmed ? "✔️" : "❌" }}
          </p>
          <!-- Roles Management -->
          <div class="mt-3 p-3 border row rounded bg-light">
            <div class="col-8">
              <h6>Role Control</h6>

              <!-- Current role -->
              @if (user.role) {
              <span class="badge bg-primary me-2">
                {{ user.role }}
                @if (user.role !== 'User') {
                <button
                  class="btn btn-sm btn-outline-light ms-1"
                  title="Revoke Role"
                  (click)="revokeRole(user.id, user.role)"
                  [disabled]="isLoading"
                >
                  <i class="fas fa-times"></i>
                </button>
                }
              </span>
              }

              <!-- Assign new role -->
              <div class="d-flex gap-2 align-items-center mt-2">
                <select
                  class="form-select form-select-sm me-2"
                  [(ngModel)]="user.selectedRole"
                >
                  <option [ngValue]="null">Select role...</option>
                  @for (role of roles; track role.name) { @if (role.name !==
                  user.role) {
                  <option [ngValue]="role.name">{{ role.name }}</option>
                  } }
                </select>
                <button
                  class="btn btn-sm btn-success"
                  (click)="assignRole(user.id, user.selectedRole!)"
                  [disabled]="!user.selectedRole || isLoading"
                >
                  Assign
                </button>
              </div>
            </div>
            @if (user.activeStatus !== "Suspend") {

            <div
              class="col-4 d-flex flex-column gap-2 align-items-center justify-content-end text-center"
            >
              <h6>Action</h6>

              <button
                class="btn btn-sm btn-active rounded-circle me-2"
                [ngClass]="
                  user.activeStatus === 'Active' ? 'bg-danger' : 'bg-success'
                "
                (click)="
                  user.activeStatus === 'Active'
                    ? deactivateUser(user.id)
                    : activateUser(user.id)
                "
                [disabled]="isLoading"
              >
                <i class="fa-solid fa-power-off"></i>
              </button>
              <p>
                {{
                  user.activeStatus === "Active"
                    ? "Deactivate User"
                    : "Activate User"
                }}
              </p>
            </div>
            }@else{
            <div
              class="col-4 d-flex flex-column gap-2 align-items-center justify-content-end text-center"
            >
              <h6>Action</h6>
              <button
                class="btn btn-sm btn-danger me-2"
                (click)="deleteUser(user.id)"
                [disabled]="isLoading"
              >
                <i class="fa-solid fa-trash"></i> Delete User
              </button>
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div
        *ngIf="!isLoading && !users.length && !errorMessage"
        class="alert alert-info"
      >
        No users found.
      </div>
    </div>
  </div>
</div>
