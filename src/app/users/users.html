<div class="container mt-4">
  <div
    class="d-flex flex-column flex-lg-row justify-content-between mb-lg-2 mb-4"
  >
    <h2 class="mb-3">User Management</h2>
    <div>
      <button
        class="btn btn-sm btn-info me-2"
        (click)="viewAllActivities()"
        [disabled]="isLoading"
      >
        <i class="fa-solid fa-list"></i> View All Activities
      </button>
      <button
        class="btn btn-sm btn-secondary me-2"
        (click)="viewAllLogins()"
        [disabled]="isLoading"
      >
        <i class="fa-solid fa-list"></i> View All Logins
      </button>
    </div>
  </div>
  <!-- Role Filter -->
  <div class="mb-3">
    <select
      id="roleFilter"
      class="form-select"
      [(ngModel)]="selectedRole"
      (change)="onRoleChange()"
    >
      <option value="">All Roles</option>
      <option *ngFor="let role of roles" [value]="role.name">
        {{ role.name }}
      </option>
    </select>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading users...</p>
  </div>

  <!-- Error message -->
  <div *ngIf="!isLoading && errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Accordion with users -->
  <div class="accordion" id="usersAccordion" *ngIf="!isLoading && users.length">
    <div class="accordion-item" *ngFor="let user of users; let i = index">
      <h2 class="accordion-header" id="heading{{ i }}">
        <button
          class="accordion-button collapsed d-flex justify-content-between"
          type="button"
          data-bs-toggle="collapse"
          [attr.data-bs-target]="'#collapse' + i"
          aria-expanded="false"
          [attr.aria-controls]="'collapse' + i"
        >
          <div class="row w-100 justify-content-between">
            <div class="col-6 col-md-8">
              <strong>{{ user.fullName }}</strong>
              <span class="text-muted ms-2 d-none d-md-inline"
                >({{ user.email }})</span
              >
            </div>
            <div class="col-6 col-md-4 text-end">
              <span [class]="getStatusClass(user.activeStatus)">
                {{ user.activeStatus }}
              </span>
              <span
                class="badge ms-2"
                [ngClass]="
                  user.role === 'Admin' ? 'bg-primary' : 'bg-secondary'
                "
              >
                {{ user.role }}
              </span>
            </div>
          </div>
        </button>
      </h2>
      <div
        [id]="'collapse' + i"
        class="accordion-collapse collapse"
        [attr.aria-labelledby]="'heading' + i"
        data-bs-parent="#usersAccordion"
      >
        <div class="accordion-body">
          <p><strong>Full Name:</strong> {{ user.fullName }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p>
            <strong>Birthdate:</strong>
            {{
              user.birthdate ? (user.birthdate | date : "mediumDate") : "N/A"
            }}
          </p>
          <p><strong>Region:</strong> {{ user.region || "N/A" }}</p>
          <p>
            <strong>Email Confirmed:</strong>
            {{ user.emailConfirmed ? "✔️" : "❌" }}
          </p>
          <!-- Roles Management -->
          <div class="mt-3 p-3 gap-3 gap-xl-0 border row rounded bg-light">
            <div class="col-xl-8 col-12">
              <h6>Role Control</h6>

              <!-- Current role -->
              @if (user.role) {
              <span class="badge bg-primary me-2">
                {{ user.role }}
                @if (user.role !== 'User') {
                <button
                  class="btn btn-sm btn-outline-light ms-1"
                  title="Revoke Role"
                  (click)="revokeRole(user.id, user.role)"
                  [disabled]="isLoading"
                >
                  <i class="fas fa-times"></i>
                </button>
                }
              </span>
              }

              <!-- Assign new role -->
              <div class="d-flex gap-2 align-items-center mt-2">
                <select
                  class="form-select form-select-sm me-2"
                  [(ngModel)]="user.selectedRole"
                >
                  <option [ngValue]="null">Select role...</option>
                  @for (role of roles; track role.name) { @if (role.name !==
                  user.role) {
                  <option [ngValue]="role.name">{{ role.name }}</option>
                  } }
                </select>
                <button
                  class="btn btn-sm btn-success"
                  (click)="assignRole(user.id, user.selectedRole!)"
                  [disabled]="!user.selectedRole || isLoading"
                >
                  Assign
                </button>
              </div>
            </div>

            <div
              class="col-xl-4 col-12 d-flex flex-column gap-2 align-items-xl-center justify-content-end text-xl-center"
            >
              <h6>Actions</h6>
              <div class="d-flex gap-3">
                @if (user.activeStatus !== "Suspend") {

                <button
                  class="btn btn-sm d-flex align-items-center justify-content-center gap-2"
                  [ngClass]="
                    user.activeStatus === 'Active'
                      ? 'btn-danger'
                      : 'btn-success'
                  "
                  (click)="
                    user.activeStatus === 'Active'
                      ? deactivateUser(user.id)
                      : activateUser(user.id)
                  "
                  [disabled]="isLoading"
                >
                  <i class="fa-solid fa-power-off"></i>
                  <div>
                    {{
                      user.activeStatus === "Active"
                        ? "Deactivate User"
                        : "Activate User"
                    }}
                  </div>
                </button>
                }@else{

                <button
                  class="btn btn-sm btn-danger me-2"
                  (click)="deleteUser(user.id)"
                  [disabled]="isLoading"
                >
                  <i class="fa-solid fa-trash"></i> Delete User
                </button>

                }
                <button
                  class="btn btn-sm btn-info me-2"
                  (click)="viewActivities(user.id)"
                  [disabled]="isLoading"
                >
                  <i class="fa-solid fa-list"></i> View Activities
                </button>
                <button
                  class="btn btn-sm btn-secondary me-2"
                  (click)="viewLogins(user.id)"
                  [disabled]="isLoading"
                >
                  <i class="fa-solid fa-list"></i> View Logins
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div
        *ngIf="!isLoading && !users.length && !errorMessage"
        class="alert alert-info"
      >
        No users found.
      </div>
    </div>
  </div>
</div>
